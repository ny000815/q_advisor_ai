<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDB+ and q Language Learning Platform</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/q.min.js"></script>
    <style>
		body, html {
			margin: 0;
			padding: 0;
			height: 100%;
			font-family: Arial, sans-serif;
			overflow: hidden;
		}
		.container {
			display: flex;
			height: 100vh;
		}
		.window {
			display: flex;
			flex-direction: column;
			border: 1px solid #ccc;
			box-sizing: border-box;
			flex: 1;
		}
		.tab-bar {
			display: flex;
			background-color: #f1f3f4;
			padding: 5px 5px 0;
			user-select: none;
			overflow-x: auto;
			white-space: nowrap;
		}
		.tab {
			background-color: #ccc;;
			border: 1px solid #fff;
			border-bottom: none;
			padding: 8px 20px;
			margin-right: 2px;
			cursor: pointer;
			display: flex;
			align-items: center;
			border-top-left-radius: 8px;
			border-top-right-radius: 8px;
			white-space: nowrap;
		}
		.tab.active {
			background-color: #f1f3f4;
			border-bottom: 1px solid #ccc;
		}
		.tab-close {
			margin-left: 10px;
			cursor: pointer;
			font-size: 14px;
			color: #666;
		}
		.tab-close:hover {
			color: #000;
		}
		.new-tab-button, .new-window-button {
			background-color: #4a4a4a;
			border: none;
			padding: 8px 12px;
			cursor: pointer;
			font-size: 20px;
			flex-shrink: 0;
			color: white
		}
		.content-area {
			flex-grow: 1;
			background-color: #fff;
			padding: 20px;
			overflow: auto;
		}
		.panel {
			display: none;
			height: 100%;
		}
		.panel.active {
			display: block;
		}
		textarea {
			width: 100%;
			height: 200px;
			margin-bottom: 10px;
			border: 1px solid #ccc;
			padding: 10px;
			font-family: monospace;
			font-size: 14px;
		}
        #chat-messages {
            height: 70vh;
            overflow-y: auto;
        }
		.message {
			margin-bottom: 15px;
			padding: 10px;
			border-radius: 5px;
			max-width: 80%;
		}
        .user-message {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }


		.message strong {
			display: block;
			margin-bottom: 5px;
			font-size: 0.9em;
			color: #555;
		}
		#user-input {
			width: calc(100% - 80px);
			padding: 10px;
			margin-right: 10px;
			border: 1px solid #ccc;
			border-radius: 4px;
		}
		button {
			padding: 10px 20px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
		button:hover {
			background-color: #45a049;
		}
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.4);
		}
		.modal-content {
			background-color: #fefefe;
			margin: 15% auto;
			padding: 20px;
			border: 1px solid #888;
			width: 300px;
			border-radius: 5px;
		}
		.modal-button {
			display: block;
			width: 100%;
			padding: 10px;
			margin-top: 10px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
		.modal-button:hover {
			background-color: #45a049;
		}
		#debug-toggle {
			position: fixed;
			bottom: 10px;
			right: 10px;
			z-index: 1000;
			padding: 5px 10px;
			background-color: #f1f3f4;
			border: 1px solid #ccc;
			cursor: pointer;
			border-radius: 4px;
			font-size: 12px;
		}
		#debug-info {
			display: none;
			position: fixed;
			bottom: 40px;
			right: 10px;
			width: 300px;
			height: 200px;
			overflow-y: auto;
			background: rgba(255, 255, 255, 0.95);
			padding: 10px;
			border: 1px solid #ccc;
			z-index: 1000;
			font-size: 12px;
			border-radius: 4px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}
		#concept-map-content {
			font-family: Arial, sans-serif;
		}
		#concept-map-content button {
			margin: 5px 0;
			background-color: #f0f0f0;
			border: 1px solid #ccc;
			padding: 5px 10px;
			border-radius: 3px;
			cursor: pointer;
			transition: background-color 0.3s;
		}
		#concept-map-content button:hover {
			background-color: #e0e0e0;
		}
		#challenge-title {
			font-size: 1.2em;
			margin-bottom: 10px;
		}
		#challenge-description {
			margin-bottom: 15px;
		}
		#test-cases {
			margin-bottom: 15px;
		}
		#challenge-output {
			background-color: #f0f0f0;
			padding: 10px;
			border-radius: 4px;
			font-family: monospace;
			white-space: pre-wrap;
		}
		.ai-message {
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .ai-message pre {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 3px;
            padding: 10px;
            overflow-x: auto;
            color: #d4d4d4;
        }

        .ai-message code {
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            background-color: #2b2b2b;
            padding: 2px 4px;
            border-radius: 3px;
            color: #d4d4d4;
        }

		.hljs-keyword { color: #569cd6; }
        .hljs-string { color: #ce9178; }
        .hljs-number { color: #b5cea8; }
        .hljs-comment { color: #6a9955; }
        .hljs-function { color: #dcdcaa; }

        .ai-message table {
            border-collapse: collapse;
            margin: 15px 0;
        }

        .ai-message th, .ai-message td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .ai-message th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .ai-message img {
            max-width: 100%;
            height: auto;
        }
        .ai-message blockquote {
            border-left: 4px solid #ccc;
            margin: 0;
            padding-left: 16px;
            color: #666;
        }
		pre code.hljs {
            padding: 0;
            background: transparent;
        }
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
			overflow-x: auto;
        }
        .code-block pre {
            margin: 0;
        }
        .code-block code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
			color: #d4d4d4;
        }
 	</style>
</head>
<body>
    <div id="debug-info">
        <h2>Debug Info</h2>
        <p>If you can see this, the HTML is being served correctly.</p>
    </div>

    <div class="container" id="container">
        <div class="window" id="main-window">
            <div class="tab-bar" id="tab-bar">
                <div class="tab active" draggable="true" data-panel="chat">Chat<span class="tab-close">×</span></div>
                <div class="tab" draggable="true" data-panel="challenges">Challenges<span class="tab-close">×</span></div>
                <button class="new-tab-button" onclick="showNewTabModal(this.closest('.window'))">+</button>
                <button class="new-window-button" onclick="splitWindow()">◫</button>
            </div>
            <div class="content-area">
                <div class="panel active" id="chat">
                    <div id="chat-messages"></div>
                    <input type="text" id="user-input" placeholder="Ask about q language...">
                    <button onclick="sendMessage()">Send</button>
                </div>
                <div class="panel" id="challenges">
                    <h3 id="challenge-title"></h3>
                    <p id="challenge-description"></p>
                    <textarea id="challenge-code" placeholder="Write your solution here..."></textarea>
                    <button onclick="submitChallenge()">Submit Solution</button>
                    <h4>Test Cases:</h4>
                    <ul id="test-cases"></ul>
                    <h4>Feedback:</h4>
                    <pre id="challenge-output"></pre>
                </div>
                </div>
            </div>
        </div>
    </div>

    <div id="newTabModal" class="modal">
        <div class="modal-content">
            <h2>Choose tab content:</h2>
            <button class="modal-button" onclick="createNewTab('chat')">Chat</button>
            <button class="modal-button" onclick="createNewTab('challenges')">Challenges</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <script>
        // Debug function to check if JavaScript is running
		function debugLog(message) {
            console.log(message);
            document.getElementById('debug-info').innerHTML += `<p>${message}</p>`;
        }

        function toggleDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

		function formatCode(code) {
            return hljs.highlightAuto(code).value;
        }

        function sendMessage() {
            debugLog("sendMessage function called");
            const userInput = document.getElementById('user-input');
            const chatMessages = document.getElementById('chat-messages');
            const message = userInput.value;
            if (message.trim() === '') return;

            chatMessages.innerHTML += `
                <div class="message user-message">
                    <strong>You:</strong>
                    ${message}
                </div>`;
            userInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            debugLog("Sending AJAX request");
            $.ajax({
                url: '/api/ask',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ query: message }),
                success: function(response) {
                    debugLog("Received response from server");
                    const formattedResponse = response.answer.replace(/<pre><code class="language-q">([\s\S]*?)<\/code><\/pre>/g, function(match, p1) {
                        return `<div class="code-block"><pre><code class="language-q">${p1}</code></pre></div>`;
                    });
                    chatMessages.innerHTML += `
                        <div class="message ai-message">
                            <strong>AI:</strong>
                            ${formattedResponse}
                        </div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    hljs.highlightAll();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    debugLog(`Error: ${textStatus}, ${errorThrown}`);
                    chatMessages.innerHTML += `
                        <div class="message ai-message">
                            <strong>AI:</strong>
                            Sorry, I encountered an error while processing your request.
                        </div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

		const chatMessages = document.getElementById('chat-messages');
        const observer = new MutationObserver(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
        observer.observe(chatMessages, { childList: true });

        function formatResponse(response) {
            // Split the response into paragraphs
            const paragraphs = response.split('\n\n');
            // Format each paragraph
            return paragraphs.map(p => `<p>${p}</p>`).join('');
        }

        // Window and tab functionality
        const container = document.getElementById('container');
        let draggedTab = null;
        let draggedWindow = null;
        let currentWindow = null;

        function setActiveTab(tab) {
            const window = tab.closest('.window');
            window.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            window.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            window.querySelector(`#${tab.dataset.panel}`).classList.add('active');
        }

        function showNewTabModal(window) {
            currentWindow = window;
            document.getElementById('newTabModal').style.display = 'block';
        }

        function createNewTab(panelType) {
            const newTab = document.createElement('div');
            newTab.className = 'tab';
            newTab.draggable = true;
            newTab.dataset.panel = `${panelType}-${Date.now()}`;
            newTab.innerHTML = `${panelType}<span class="tab-close">×</span>`;
            
            currentWindow.querySelector('.tab-bar').insertBefore(newTab, currentWindow.querySelector('.new-tab-button'));
            
            const newPanel = document.createElement('div');
            newPanel.className = 'panel';
            newPanel.id = newTab.dataset.panel;
            newPanel.innerHTML = document.getElementById(panelType).innerHTML;
            currentWindow.querySelector('.content-area').appendChild(newPanel);
            
            setActiveTab(newTab);
            document.getElementById('newTabModal').style.display = 'none';
        }

        function splitWindow() {
            if (container.children.length < 2) {
                const existingWindow = container.firstElementChild;
                const newWindow = existingWindow.cloneNode(true);
                
                newWindow.querySelector('.tab-bar').innerHTML = `
                    <button class="new-tab-button" onclick="showNewTabModal(this.closest('.window'))">+</button>
                    <button class="new-window-button" onclick="splitWindow()">◫</button>
                `;
                newWindow.querySelector('.content-area').innerHTML = '';

                container.appendChild(newWindow);
                setupWindowListeners(newWindow);

                existingWindow.style.width = '50%';
                newWindow.style.width = '50%';
            }
        }

        function setupWindowListeners(window) {
            const tabBar = window.querySelector('.tab-bar');

            tabBar.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab')) {
                    setActiveTab(e.target);
                } else if (e.target.classList.contains('tab-close')) {
                    closeTab(e.target.closest('.tab'));
                }
            });

            tabBar.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('tab')) {
                    draggedTab = e.target;
                    draggedWindow = window;
                    e.dataTransfer.setData('text/plain', e.target.dataset.panel);
                }
            });

            tabBar.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            tabBar.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedTab) {
                    const targetWindow = e.target.closest('.window');
                    const targetTabBar = targetWindow.querySelector('.tab-bar');
                    if (e.target.classList.contains('tab')) {
                        const targetRect = e.target.getBoundingClientRect();
                        const targetMiddle = targetRect.left + targetRect.width / 2;
                        if (e.clientX < targetMiddle) {
                            targetTabBar.insertBefore(draggedTab, e.target);
                        } else {
                            targetTabBar.insertBefore(draggedTab, e.target.nextSibling);
                        }
                    } else {
                        targetTabBar.insertBefore(draggedTab, targetTabBar.querySelector('.new-tab-button'));
                    }
                    movePanel(draggedTab, targetWindow);
                    draggedTab = null;
                    draggedWindow = null;
                }
            });
        }

        function movePanel(tab, targetWindow) {
            const panel = draggedWindow.querySelector(`#${tab.dataset.panel}`);
            targetWindow.querySelector('.content-area').appendChild(panel);
        }

        function closeTab(tab) {
            const window = tab.closest('.window');
            const panel = window.querySelector(`#${tab.dataset.panel}`);
            tab.remove();
            panel.remove();

            if (window.querySelectorAll('.tab').length === 0 && container.children.length > 1) {
                window.remove();
                container.firstElementChild.style.width = '100%';
            } else if (window.querySelectorAll('.tab').length > 0) {
                setActiveTab(window.querySelector('.tab'));
            }
        }

        setupWindowListeners(document.getElementById('main-window'));

        // Chat functionality
        function sendMessage() {
            debugLog("sendMessage function called");
            const userInput = document.getElementById('user-input');
            const chatMessages = document.getElementById('chat-messages');
            const message = userInput.value;
            if (message.trim() === '') return;

            chatMessages.innerHTML += `<p><strong>You:</strong> ${message}</p>`;
            userInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            debugLog("Sending AJAX request");
            // Send request to Flask backend
            $.ajax({
                url: '/api/ask',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ query: message }),
                success: function(response) {
                    debugLog("Received response from server");
                    
                    // Log the raw API response to the console
                    console.log("Raw API Response:", response);
                    
                    const formattedResponse = response.answer.replace(/<pre><code class="language-q">([\s\S]*?)<\/code><\/pre>/g, function(match, p1) {
                        return `<div class="code-block"><pre><code class="language-q">${p1}</code></pre></div>`;
                    });
                    chatMessages.innerHTML += `
                        <div class="message ai-message">
                            <strong>AI:</strong>
                            ${formattedResponse}
                        </div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    hljs.highlightAll();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    debugLog(`Error: ${textStatus}, ${errorThrown}`);
                    console.error("AJAX Error:", jqXHR.responseText);
                    chatMessages.innerHTML += `
                        <div class="message ai-message">
                            <strong>AI:</strong>
                            Sorry, I encountered an error while processing your request.
                        </div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        // Challenge functionality
		let currentChallenge = 0;
let challengeData;

// グローバルスコープで submitSolution 関数を定義
window.submitSolution = function() {
    const solution = document.getElementById('solution').value;
    const correctSolution = challengeData.topics[currentChallenge].exercise.solution.join('\n');
    const challengeOutput = document.getElementById('challenge-output');
    if (solution.trim() === correctSolution.trim()) {
        challengeOutput.textContent = "Correct! Well done!";
    } else {
        challengeOutput.textContent = "Incorrect. Try again!";
    }
}

fetch('/static/challenges.json')
    .then(response => response.json())
    .then(data => {
        challengeData = data;  // グローバル変数に保存
        const challengesPanel = document.getElementById('challenges');
        const challengeTitle = document.getElementById('challenge-title');

        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous Challenge';
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next Challenge';

        function displayChallenge(index) {
            const challenge = challengeData.topics[index];
            challengeTitle.textContent = challenge.topic;
            challengesPanel.innerHTML = `
                <h3>${challenge.topic}</h3>
                <p>${challenge.description}</p>
                <h4>Example:</h4>
                <pre class="code-block"><code>${challenge.example.code.join('\n')}</code></pre>
                <p>${challenge.example.explanation}</p>
                <h4>Exercise:</h4>
                <p>${challenge.exercise.prompt}</p>
                <textarea id="solution" rows="5" cols="50"></textarea>
                <button id="submitButton">Submit Solution</button>
                <h4>Feedback:</h4>
                <pre id="challenge-output"></pre>
            `;

            // イベントリスナーを使用してボタンにクリックイベントを追加
            document.getElementById('submitButton').addEventListener('click', submitSolution);

            prevButton.style.display = index > 0 ? 'inline-block' : 'none';
            nextButton.style.display = index < challengeData.topics.length - 1 ? 'inline-block' : 'none';

            challengesPanel.appendChild(prevButton);
            challengesPanel.appendChild(nextButton);
        }

        prevButton.onclick = () => {
            if (currentChallenge > 0) {
                currentChallenge--;
                displayChallenge(currentChallenge);
            }
        };

        nextButton.onclick = () => {
            if (currentChallenge < challengeData.topics.length - 1) {
                currentChallenge++;
                displayChallenge(currentChallenge);
            }
        };

        displayChallenge(currentChallenge);
    })
    .catch(error => console.error('Error loading challenges:', error));

        // Initialize the application
        function initializeApp() {
            debugLog("Initializing application");
            // Set up event listeners
            document.getElementById('user-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Initialize challenge

            debugLog("Application initialized successfully");
        }

        // Call initializeApp when the document is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        debugLog("JavaScript initialization complete");
    </script>
</body>
</html>